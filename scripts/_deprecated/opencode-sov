#!/bin/bash
# 游분 Open Code Sovereign Wrapper (v2.0 Polyfill)
# Permite usar o schema de configura칞칚o v2.0 (opencode.json) com o bin치rio v1.x.
# Oculta o arquivo JSON incompat칤vel durante a execu칞칚o e injeta as configura칞칫es via flags.

CONFIG_FILE="opencode.json"
HIDDEN_CONFIG=".opencode.json.sov.tmp"

# Funcao de limpeza garantida (Trap)
restore_config() {
    if [ -f "$HIDDEN_CONFIG" ]; then
        mv "$HIDDEN_CONFIG" "$CONFIG_FILE"
    fi
}
trap restore_config EXIT

# 1. Carregar vari치veis do .env (Soberania de Chaves)
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# 2. Configurar identidade Git (Soberania de Identidade)
if [ -z "$(git config --global user.email)" ]; then
    git config --global user.email "jarvis@antigravity.sov"
    git config --global user.name "Jarvis Sovereign"
fi

# 3. Parse Inteligente da Configura칞칚o v2.0
ARGS=""

if [ -f "$CONFIG_FILE" ]; then
    echo "丘뙖잺  Lendo opencode.json (v2.0)..."
    
    # Extra칞칚o robusta usando python3
    # Mapeia: ai.model -> -m, ai.temperature -> (ignoramos se CLI nao suportar ou passamos via env se suportado)
    # Por enquanto, focamos no MODEL que 칠 critico.
    
    PY_PAYLOAD="
import json, sys
try:
    with open('$CONFIG_FILE') as f:
        data = json.load(f)
        ai = data.get('ai', {})
        model = ai.get('model')
        provider = ai.get('provider')
        if model:
            if provider:
                print(f'MODEL={provider}/{model}')
            else:
                print(f'MODEL={model}')
except Exception as e:
    sys.stderr.write(f'Erro no parse: {e}\n')
"
    # Executa o python e avalia as variaveis exportadas
    eval "$(python3 -c "$PY_PAYLOAD")"

    if [ ! -z "$MODEL" ]; then
        # Verifica se o usu치rio j치 passou a flag -m nos argumentos manuais
        if [[ "$*" != *"-m"* ]]; then
            ARGS="$ARGS -m $MODEL"
            echo "游꿢 Modelo Selecionado (Config): $MODEL"
        else
            echo "丘멆잺  Config de modelo ignorada (sobrescrita por argumento manual)"
        fi
    fi

    # Oculta o arquivo v2.0 para evitar crash do bin치rio v1.1.60
    # "Unrecognized keys: project, ai..."
    mv "$CONFIG_FILE" "$HIDDEN_CONFIG"
fi

# 4. Execu칞칚o do Bin치rio Legado
echo "游분 Executing Open Code CLI..."
/usr/bin/opencode $ARGS "$@"
