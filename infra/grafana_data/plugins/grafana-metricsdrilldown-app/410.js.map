{"version":3,"file":"410.js?_cache=d81a4590c8fbe87ff2b7","mappings":"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","sources":["webpack://grafana-metricsdrilldown-app/./App/AppContext.tsx","webpack://grafana-metricsdrilldown-app/./App/ErrorView.tsx","webpack://grafana-metricsdrilldown-app/./App/HelpControls.tsx","webpack://grafana-metricsdrilldown-app/./App/Routes.tsx","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/behaviors/FilterGroupByAssertsLabelsBehavior.ts","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/behaviors/HistogramPercentilesDefaultBehavior.ts","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/SourceMetrics.tsx","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.timerange.ts"],"sourcesContent":["import { createContext, useContext } from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { newMetricsTrail } from 'shared/utils/utils';\n\ninterface AppContextState {\n  trail: DataTrail;\n}\n\nexport const defaultTrail = newMetricsTrail();\n\nexport const AppContext = createContext<AppContextState>({\n  trail: defaultTrail,\n});\n\nexport function useMetricsAppContext() {\n  return useContext(AppContext);\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { t, Trans } from '@grafana/i18n';\nimport { Collapse, TextLink, useStyles2 } from '@grafana/ui';\nimport React, { useCallback, useState } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\n\nimport { HelpControls } from './HelpControls';\nimport { InlineBanner } from './InlineBanner';\n\ntype ErrorViewProps = { error: Error };\n\nexport function ErrorView({ error }: Readonly<ErrorViewProps>) {\n  const styles = useStyles2(getStyles);\n\n  const navigate = useNavigate();\n  const { pathname, search } = useLocation();\n\n  const onClickReload = useCallback(() => {\n    const searchParams = new URLSearchParams(search);\n    const newSearchParams = new URLSearchParams();\n\n    // these are safe keys to keep\n    ['from', 'to', 'timezone']\n      .filter((key) => searchParams.has(key))\n      .forEach((key) => newSearchParams.set(key, searchParams.get(key)!));\n\n    navigate({ pathname, search: newSearchParams.toString() });\n    window.location.reload();\n  }, [navigate, pathname, search]);\n\n  const [isCollapseOpen, setIsCollapseOpen] = useState(false);\n\n  return (\n    <div className={styles.container}>\n      <HelpControls />\n      <InlineBanner\n        severity=\"error\"\n        title={t('error-view.title', 'Fatal error!')}\n        error={error}\n        errorContext={{ handheldBy: 'React error boundary' }}\n        message={\n          <>\n            <p className={styles.message}>\n              <Trans i18nKey=\"error-view.message\">\n                Please{' '}\n                <TextLink href=\"#\" onClick={onClickReload}>\n                  try reloading the page\n                </TextLink>{' '}\n                or, if the problem persists, contact your organization admin. Sorry for the inconvenience.\n              </Trans>\n            </p>\n            <p>\n              <Collapse\n                className={styles.callStack}\n                label={t('error-view.stack-trace-label', 'View stack trace')}\n                isOpen={isCollapseOpen}\n                onToggle={() => setIsCollapseOpen(!isCollapseOpen)}\n              >\n                <pre>\n                  <code>{error.stack}</code>\n                </pre>\n              </Collapse>\n            </p>\n          </>\n        }\n      />\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      position: 'relative',\n      margin: theme.spacing(2),\n    }),\n    message: css({\n      margin: theme.spacing(2, 0, 1, 0),\n    }),\n    callStack: css({\n      backgroundColor: 'transparent',\n      border: '0 none',\n\n      '& button': css({\n        paddingLeft: theme.spacing(1.5),\n      }),\n\n      '& button:focus': css({\n        outline: 'none',\n        boxShadow: 'none',\n      }),\n\n      '& button > svg': css({\n        marginLeft: theme.spacing(-2),\n        marginRight: theme.spacing(0.5),\n      }),\n\n      '& [class$=\"collapse__loader\"]': css({\n        display: 'none',\n      }),\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Stack, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { GiveFeedbackButton } from 'AppDataTrail/header/GiveFeedbackButton';\nimport { PluginInfo } from 'AppDataTrail/header/PluginInfo/PluginInfo';\n\nexport function HelpControls() {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <Stack direction=\"row\" gap={1} alignItems=\"center\">\n        <GiveFeedbackButton className={styles.feedbackStatic} />\n        <PluginInfo />\n      </Stack>\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      position: 'absolute',\n      top: theme.spacing(2),\n      right: theme.spacing(2),\n      zIndex: theme.zIndex.dropdown,\n    }),\n    feedbackStatic: css({\n      position: 'static',\n    }),\n  };\n}\n","import React, { lazy } from 'react';\nimport { Navigate, Route, Routes, useLocation } from 'react-router-dom';\n\nimport { ROUTES } from 'shared/constants/routes';\n\nimport { useMetricsAppContext } from './AppContext';\n\nexport const Trail = lazy(() => import('./Trail'));\n\n// For /trail links, redirect to /drilldown with the same search params\nconst TrailRedirect = () => {\n  const location = useLocation();\n  return <Navigate to={`${ROUTES.Drilldown}${location.search}`} replace />;\n};\n\nexport const AppRoutes = () => {\n  const { trail } = useMetricsAppContext();\n\n  return (\n    <Routes>\n      <Route path={ROUTES.Drilldown} element={<Trail trail={trail} />} />\n      <Route path={ROUTES.Trail} element={<TrailRedirect />} />\n      {/* catch-all route */}\n      <Route path=\"*\" element={<Navigate to={ROUTES.Drilldown} replace />} />\n    </Routes>\n  );\n};\n","import { SceneObjectBase, type SceneObjectState } from \"@grafana/scenes\";\n\nimport { GroupByOptionsLoadedEvent, type GroupByVariable } from \"MetricScene/Breakdown/GroupByVariable\";\n\n/**\n * Behavior that filters out \"asserts_*\" labels from the Breakdown view.\n * Subscribes at the root level to catch bubbled events from GroupByVariable when options are loaded.\n */\nexport class FilterGroupByAssertsLabelsBehavior extends SceneObjectBase<SceneObjectState> {\n  public constructor(params: { metric: string | undefined }) {\n    super({});\n\n    this.addActivationHandler(() => {\n      // Subscribe to the event at the root level to catch bubbled events\n      const subscription = this.getRoot().subscribeToEvent(GroupByOptionsLoadedEvent, (event) => {\n        if (params.metric?.startsWith('asserts')) {\n          // Avoid filtering asserts labels if selecting an asserts metric (not a source metric)\n          return;\n        }\n\n        this.filterVariableOptions(event.payload);\n      });\n      \n      return () => subscription.unsubscribe();\n    });\n  }\n\n  private filterVariableOptions(variable: GroupByVariable) {\n    const currentOptions = variable.state.options;\n\n    if (currentOptions.length === 0) {\n      return;\n    }\n\n    const filtered = currentOptions.filter((option) => !String(option.value).startsWith('asserts'));\n    \n    if (filtered.length !== currentOptions.length) {\n      variable.setState({ options: filtered });\n    }\n  }\n}\n","import { sceneGraph, SceneObjectBase, type SceneObjectState } from \"@grafana/scenes\";\n\nimport { GmdVizPanel } from \"shared/GmdVizPanel/GmdVizPanel\";\nimport { getMetricTypeSync } from \"shared/GmdVizPanel/matchers/getMetricType\";\nimport { PREF_KEYS } from \"shared/user-preferences/pref-keys\";\nimport { userStorage } from \"shared/user-preferences/userStorage\";\n\n/**\n * Behavior that sets histogram metrics to use percentiles as the default visualization.\n * This leverages the existing histogram preset configuration to apply percentiles by default\n * for histogram metrics in the SourceMetrics context only.\n */\nexport class HistogramPercentilesDefaultBehavior extends SceneObjectBase<SceneObjectState> {\n  private processedPanels = new WeakSet<GmdVizPanel>();\n\n  public constructor() {\n    super({});\n\n    this.addActivationHandler(() => {\n      const root = this.getRoot();\n      \n      const processPanels = () => {\n        const panels = sceneGraph.findAllObjects(root, (obj) => obj instanceof GmdVizPanel) as GmdVizPanel[];\n        \n        for (const panel of panels) {\n          // Skip if already processed\n          if (this.processedPanels.has(panel)) {\n            continue;\n          }\n          \n          const { metric, panelConfig } = panel.state;\n          const metricType = getMetricTypeSync(metric);\n          \n          // Check if user already has a preference for this metric\n          const userPrefs = userStorage.getItem(PREF_KEYS.METRIC_PREFS) || {};\n          const hasUserPreference = userPrefs[metric]?.config;\n          \n          // For histogram metrics without user preferences, apply percentiles preset\n          if ((metricType === 'classic-histogram' || metricType === 'native-histogram') && \n              !hasUserPreference &&\n              panelConfig.type === 'heatmap') {\n            // Use the histogram percentiles preset configuration\n            panel.update(\n              {\n                type: 'percentiles',\n              },\n              {\n                queries: [{ fn: 'histogram_quantile', params: { percentiles: [99, 90, 50] } }],\n              }\n            );\n          }\n          \n          this.processedPanels.add(panel);\n        }\n      };\n      \n      // Process existing panels immediately\n      processPanels();\n      \n      // Subscribe to root state changes to detect when new panels are added\n      // The WeakSet ensures we don't reprocess panels, making this efficient\n      const subscription = root.subscribeToState(processPanels);\n      \n      return () => subscription.unsubscribe();\n    });\n  }\n}\n","import { type AdHocVariableFilter, type DataSourceApi } from '@grafana/data';\nimport { locationService } from '@grafana/runtime';\nimport React, { useEffect, useRef } from 'react';\n\nimport { ErrorView } from 'App/ErrorView';\nimport { Trail } from 'App/Routes';\nimport { useCatchExceptions } from 'App/useCatchExceptions';\nimport { VAR_WINGMAN_SORT_BY } from 'MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { metricFilters } from 'MetricsReducer/SideBar/SideBar';\nimport { logger } from 'shared/logger/logger';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { embeddedTrailNamespace, newMetricsTrail } from 'shared/utils/utils';\nimport { labelMatcherToAdHocFilter } from 'shared/utils/utils.variables';\n\nimport { FilterGroupByAssertsLabelsBehavior } from './behaviors/FilterGroupByAssertsLabelsBehavior';\nimport { HistogramPercentilesDefaultBehavior } from './behaviors/HistogramPercentilesDefaultBehavior';\nimport { parsePromQLQuery } from '../../extensions/links';\nimport { type PromQLLabelMatcher } from '../../shared/utils/utils.promql';\nimport { toSceneTimeRange } from '../../shared/utils/utils.timerange';\n\n/**\n * Extracts the prefix from a Prometheus metric name.\n * The prefix is the first part of the metric name before any separator (underscore or colon).\n * Example: \"grafana_slo_threshold_expression\" → \"grafana\"\n *          \"traces_spanmetrics_calls_total\" → \"traces\"\n */\nfunction extractMetricPrefix(metricName: string): string {\n  // Match up to the first non-alphanumeric character (typically underscore or colon)\n  const match = metricName.match(/^([a-zA-Z0-9]+)/);\n  return match ? match[1] : metricName;\n}\n\n/**\n * Extracts unique prefixes from an array of metric names.\n */\nfunction extractUniquePrefixes(metricNames: string[]): string[] {\n  const prefixes = new Set(metricNames.map(extractMetricPrefix));\n  return Array.from(prefixes);\n}\n\n/**\n * Captures the possible scenarios / data combinations for the Source Metrics experience.\n * This discriminated union gives us type safety for the different scenarios, and prevents us\n * from needing to use type assertions or null checks in the KnowledgeGraphSourceMetrics component.\n *\n * `fallbackQuery` typically contains an `asserts:*` recording rule metric and labels.\n */\ntype SourceMetricsScenario =\n  | {\n      scenario: 'recording_rule_fallback';\n      sourceMetrics: undefined;\n      fallbackQuery: ReturnType<typeof parsePromQLQuery>;\n    }\n  | {\n      scenario: 'single_source_metric';\n      sourceMetrics: SourceMetrics;\n      fallbackQuery: undefined;\n    }\n  | {\n      scenario: 'multiple_source_metrics';\n      sourceMetrics: SourceMetrics;\n      fallbackQuery: undefined;\n    }\n  | {\n      scenario: 'missing_metric_information';\n      sourceMetrics: undefined;\n      fallbackQuery: undefined;\n    };\n\nfunction getSourceMetricsScenario(props: Pick<SourceMetricsProps, 'query' | 'sourceMetrics'>): SourceMetricsScenario {\n  if (props.sourceMetrics && props.sourceMetrics.length > 0) {\n    return {\n      scenario: props.sourceMetrics.length === 1 ? 'single_source_metric' : 'multiple_source_metrics',\n      sourceMetrics: props.sourceMetrics,\n      fallbackQuery: undefined,\n    };\n  }\n\n  let fallbackQuery: ReturnType<typeof parsePromQLQuery> | undefined = undefined;\n\n  if (props.query) {\n    try {\n      fallbackQuery = parsePromQLQuery(props.query);\n    } catch (error) {\n      logger.error(new Error(`Failed to parse PromQL query: ${error}`), { query: props.query });\n    }\n  }\n\n  if (fallbackQuery) {\n    return {\n      scenario: 'recording_rule_fallback',\n      sourceMetrics: undefined,\n      fallbackQuery,\n    };\n  }\n\n  return { scenario: 'missing_metric_information', sourceMetrics: undefined, fallbackQuery: undefined };\n}\n\ntype SourceMetrics = Array<{\n  metricName: string;\n  labels: PromQLLabelMatcher[];\n}>;\n\nexport interface SourceMetricsProps {\n  query: string;\n  initialStart: string | number;\n  initialEnd: string | number;\n  dataSource: DataSourceApi;\n  sourceMetrics?: SourceMetrics;\n}\n\nconst KnowledgeGraphSourceMetrics = (props: SourceMetricsProps) => {\n  const [error] = useCatchExceptions();\n  const initRef = useRef(false);\n\n  useEffect(() => {\n    if (!initRef.current) {\n      initRef.current = true;\n      reportExploreMetrics('exposed_component_viewed', { component: 'knowledge_graph_source_metrics' });\n    }\n  }, []);\n\n  // Determine metric and filters based on data source\n  let metric: string | undefined;\n  let initialFilters: AdHocVariableFilter[] | undefined;\n\n  const { scenario, sourceMetrics, fallbackQuery } = getSourceMetricsScenario(props);\n  switch (scenario) {\n    case 'single_source_metric':\n      // If there's a single source metric, select it.\n      metric = sourceMetrics[0].metricName;\n      initialFilters = sourceMetrics[0].labels.map((label) => labelMatcherToAdHocFilter(label));\n      break;\n    case 'multiple_source_metrics':\n      // If there are multiple source metrics, we display\n      // the source metrics in the MetricsReducer, allowing\n      // users to select from the filtered list of metrics.\n      initialFilters = sourceMetrics[0].labels.map((label) => labelMatcherToAdHocFilter(label));\n\n      // Extract unique prefixes from sourceMetrics to filter the metrics list\n      // This naturally excludes metrics like \"asserts_*\" and \"ALERTS*\" that aren't in sourceMetrics\n      const prefixesToExclude = ['asserts', 'ALERTS'];\n      const sourceMetricPrefixes = extractUniquePrefixes(sourceMetrics.map((m) => m.metricName)).filter((metric) =>\n        prefixesToExclude.every((excludedPrefix) => !metric.startsWith(excludedPrefix))\n      );\n\n      // Set URL params for prefix filters BEFORE creating the trail\n      // This leverages Scenes' built-in URL sync in MetricsFilterSection\n      if (sourceMetricPrefixes?.length) {\n        const prefixUrlParam = `${embeddedTrailNamespace}-${metricFilters.prefix}`;\n        locationService.partial({ [prefixUrlParam]: sourceMetricPrefixes.join(',') }, true);\n\n        const sortByUrlParam = `${embeddedTrailNamespace}-var-${VAR_WINGMAN_SORT_BY}`;\n        locationService.partial({ [sortByUrlParam]: 'alphabetical' }, true);\n      }\n      break;\n    case 'recording_rule_fallback':\n      // When sourceMetrics aren't provided, fall back to\n      // selecting the metric from the provided PromQL query.\n      metric = fallbackQuery.metric;\n      initialFilters = fallbackQuery.labels.map((label) => labelMatcherToAdHocFilter(label));\n      break;\n    case 'missing_metric_information':\n      const err = new Error('Missing metric information for Knowledge Graph insight');\n      logger.error(err, { query: props.query });\n      return <ErrorView error={err} />;\n  }\n\n  // Create trail with behaviors:\n  // 1. Filter asserts labels from breakdown\n  // 2. Default histogram visualizations to percentiles (leveraging existing presets)\n  const trail = newMetricsTrail({\n    metric,\n    initialDS: props.dataSource.uid,\n    initialFilters,\n    $timeRange: toSceneTimeRange(props.initialStart, props.initialEnd),\n    embedded: true,\n    $behaviors: [new FilterGroupByAssertsLabelsBehavior({ metric }), new HistogramPercentilesDefaultBehavior()],\n  });\n\n  return (\n    <div data-testid=\"metrics-drilldown-embedded-label-breakdown\">\n      {error ? <ErrorView error={error} /> : <Trail trail={trail} />}\n    </div>\n  );\n};\n\nexport default KnowledgeGraphSourceMetrics;\n","import { dateMath } from '@grafana/data';\nimport { SceneTimeRange } from '@grafana/scenes';\n\ntype MathStringOrUnixTimestamp = string | number;\n\n/**\n * Convert a time string or unix timestamp to a SceneTimeRange.\n *\n * @param time - The time string or unix timestamp.\n * @returns The SceneTimeRange.\n *\n * @example\n * ```ts\n * toSceneTime('now-1h')\n * ```\n *\n * @example\n * ```ts\n * toSceneTime(1723756800000)\n * ```\n */\nfunction toSceneTime(time: MathStringOrUnixTimestamp): string {\n  if (typeof time === 'string' && dateMath.isMathString(time)) {\n    // 'now', 'now-1h', etc.\n    return time;\n  }\n\n  return dateMath.toDateTime(new Date(time), { roundUp: false })!.toISOString();\n}\n\n/**\n * Convert a time string or unix timestamp to a SceneTimeRange.\n *\n * @param from - The start time.\n * @param to - The end time.\n * @returns The SceneTimeRange.\n *\n * @example\n * ```ts\n * toSceneTimeRange('now-1h', 'now')\n * ```\n *\n * @example\n * ```ts\n * toSceneTimeRange(1723756800000, 1723756800000)\n * ```\n *\n * @example\n * ```ts\n * toSceneTimeRange('now-1h', 1723756800000)\n * ```\n */\nexport function toSceneTimeRange(from: MathStringOrUnixTimestamp, to: MathStringOrUnixTimestamp): SceneTimeRange {\n  return new SceneTimeRange({ from: toSceneTime(from), to: toSceneTime(to) });\n}\n"],"names":["defaultTrail","newMetricsTrail","AppContext","createContext","trail","useMetricsAppContext","useContext","ErrorView","error","styles","useStyles2","getStyles","navigate","useNavigate","pathname","search","useLocation","onClickReload","useCallback","searchParams","URLSearchParams","newSearchParams","filter","key","has","forEach","set","get","toString","window","location","reload","isCollapseOpen","setIsCollapseOpen","useState","div","className","container","HelpControls","InlineBanner","severity","title","t","errorContext","handheldBy","message","p","Trans","i18nKey","TextLink","href","onClick","Collapse","callStack","label","isOpen","onToggle","pre","code","stack","theme","css","position","margin","spacing","backgroundColor","border","paddingLeft","outline","boxShadow","marginLeft","marginRight","display","Stack","direction","gap","alignItems","GiveFeedbackButton","feedbackStatic","PluginInfo","top","right","zIndex","dropdown","Trail","lazy","TrailRedirect","Navigate","to","ROUTES","Drilldown","replace","AppRoutes","Routes","Route","path","element","FilterGroupByAssertsLabelsBehavior","SceneObjectBase","filterVariableOptions","variable","currentOptions","state","options","length","filtered","option","String","value","startsWith","setState","params","super","this","addActivationHandler","subscription","getRoot","subscribeToEvent","GroupByOptionsLoadedEvent","event","metric","payload","unsubscribe","HistogramPercentilesDefaultBehavior","processedPanels","WeakSet","root","processPanels","panels","sceneGraph","findAllObjects","obj","GmdVizPanel","panel","userPrefs","panelConfig","metricType","getMetricTypeSync","hasUserPreference","userStorage","getItem","PREF_KEYS","METRIC_PREFS","config","type","update","queries","fn","percentiles","add","subscribeToState","extractMetricPrefix","metricName","match","props","useCatchExceptions","initRef","useRef","initialFilters","useEffect","current","reportExploreMetrics","component","scenario","sourceMetrics","fallbackQuery","undefined","query","parsePromQLQuery","logger","Error","getSourceMetricsScenario","labels","map","labelMatcherToAdHocFilter","prefixesToExclude","sourceMetricPrefixes","metricNames","prefixes","Set","Array","from","extractUniquePrefixes","m","every","excludedPrefix","prefixUrlParam","embeddedTrailNamespace","metricFilters","prefix","locationService","partial","join","sortByUrlParam","VAR_WINGMAN_SORT_BY","err","initialDS","dataSource","uid","$timeRange","toSceneTimeRange","initialStart","initialEnd","embedded","$behaviors","data-testid","toSceneTime","time","dateMath","isMathString","toDateTime","Date","roundUp","toISOString","SceneTimeRange"],"sourceRoot":""}